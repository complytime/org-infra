name: Reusable Sign and Verify

on:
  workflow_call:
    inputs:
      image_name:
        description: 'Full image name (e.g., ghcr.io/org/image)'
        required: true
        type: string
      digest:
        description: 'Pushed image digest to sign/verify'
        required: true
        type: string
      allowed_identity_regex:
        description: 'Regex for Cosign certificate identity (optional, defaults to org-level)'
        required: false
        type: string
      sign_environment:
        description: 'Environment name to gate signing (for required reviewers)'
        required: false
        type: string
        default: 'signing'

permissions:
  packages: none
  id-token: none

concurrency:
  group: ${{ github.workflow }}-${{ inputs.image_name }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  sign:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      packages: write
      id-token: write
    environment: ${{ inputs.sign_environment }}
    steps:
      - name: Install Cosign
        uses: sigstore/cosign-installer@faadad0cce49287aee09b3a48701e75088a2c6ad # v4.0.0

      - name: Sign image
        env:
          IMAGE_INPUT: ${{ inputs.image_name }}
          DIGEST: ${{ inputs.digest }}
        run: |
          parse_images() {
            printf '%s\n' "$1" | tr ',' '\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//;/^$/d'
          }
          parse_images "$IMAGE_INPUT" | while IFS= read -r NAME; do
            IMAGE="${NAME}@${DIGEST}"
            echo "Signing: $IMAGE"
            cosign sign --yes "$IMAGE"
          done

  verify:
    needs: sign
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      packages: read
    steps:
      - name: Install Cosign
        uses: sigstore/cosign-installer@faadad0cce49287aee09b3a48701e75088a2c6ad # v4.0.0

      # Verifies signature, SLSA provenance, and SBOM (SPDX) attestations.
      # See docs/REUSABLE_PUBLISH_IMAGE.md for SBOM attestation details.
      - name: Verify signature and attestations
        env:
          IMAGE_INPUT: ${{ inputs.image_name }}
          DIGEST: ${{ inputs.digest }}
          IDENTITY_REGEX: ${{ inputs.allowed_identity_regex || format('https://github.com/{0}/.*', github.repository_owner) }}
        run: |
          parse_images() {
            printf '%s\n' "$1" | tr ',' '\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//;/^$/d'
          }
          
          verify_image() {
            local image="$1"
            echo " Verifying signature: $image"
            cosign verify "$image" \
              --certificate-identity-regexp="$IDENTITY_REGEX" \
              --certificate-oidc-issuer=https://token.actions.githubusercontent.com
            
            echo "üîç Verifying SLSA provenance attestation: $image"
            cosign verify-attestation "$image" \
              --type slsaprovenance \
              --certificate-identity-regexp="$IDENTITY_REGEX" \
              --certificate-oidc-issuer=https://token.actions.githubusercontent.com
            
            echo "üì¶ Verifying SBOM attestation: $image"
            cosign verify-attestation "$image" \
              --type spdx \
              --certificate-identity-regexp="$IDENTITY_REGEX" \
              --certificate-oidc-issuer=https://token.actions.githubusercontent.com
          }
          
          parse_images "$IMAGE_INPUT" | while IFS= read -r NAME; do
            verify_image "${NAME}@${DIGEST}"
            echo "‚úÖ All verifications passed for: ${NAME}@${DIGEST}"
          done
