# Reusable Vulnerabilities Scan Workflow
# ======================================
# - OSV-Scanner: Google's Open Source Vulnerabilities database for dependency CVEs
# - Trivy Source: Filesystem scan for vulnerabilities and secrets in source code
# - Trivy Image: Container image scan for OS packages and runtime dependencies

name: Reusable Vulnerabilities Scan

on:
  workflow_call:
    inputs:
      enable_osv:
        description: 'Enable OSV dependency scanning'
        required: false
        type: boolean
        default: true
      enable_trivy_source:
        description: 'Enable Trivy source scan (filesystem vulnerabilities)'
        required: false
        type: boolean
        default: false
      enable_secret_scan:
        description: 'Enable secret detection in Trivy source scan (requires enable_trivy_source)'
        required: false
        type: boolean
        default: true
      enable_trivy_image:
        description: 'Enable Trivy image vulnerability scan (requires image_ref)'
        required: false
        type: boolean
        default: false
      path:
        description: 'Path to scan for source scans'
        required: false
        type: string
        default: '.'
      skip_dirs:
        description: 'Comma-separated directories to skip in source scan'
        required: false
        type: string
        default: 'node_modules,.git,vendor,dist,.venv'
      image_ref:
        description: 'Image reference for image scan, e.g., ghcr.io/org/image:sha-<sha>'
        required: false
        type: string
        default: ''
      trivy_severity:
        description: 'Severity levels to fail/report'
        required: false
        type: string
        default: 'HIGH,CRITICAL'
      ignore_unfixed:
        description: 'Ignore unfixed vulnerabilities (vuln scans)'
        required: false
        type: boolean
        default: true
      upload_sarif:
        description: 'Upload SARIF results to code scanning'
        required: false
        type: boolean
        default: true
      fail_on_vuln:
        description: 'Fail the job when findings are detected'
        required: false
        type: boolean
        default: true
      scan-args:
        description: 'Additional arguments to pass to osv-scanner'
        required: false
        type: string

permissions:
  contents: read
  issues: none
  pull-requests: none
  actions: none
  security-events: none

# Prevent duplicate scans for the same ref
concurrency:
  group: reusable-vuln-scan-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate_inputs:
    name: Validate Inputs
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Validate image_ref when trivy image scan enabled
        if: ${{ inputs.enable_trivy_image && inputs.image_ref == '' }}
        run: |
          echo "::error::enable_trivy_image is true but image_ref is not provided"
          exit 1

  call_ext_osv_scanner:
    name: OSV-Scanner
    if: ${{ inputs.enable_osv }}
    uses: google/osv-scanner-action/.github/workflows/osv-scanner-reusable-pr.yml@375a0e8ebdc98e99b02ac4338a724f5750f21213 # v2.3.1
    permissions:
      contents: read
      actions: read
      security-events: write
    with:
      scan-args: "${{ inputs.scan-args }}"
      fail-on-vuln: ${{ inputs.fail_on_vuln }}
      upload-sarif: ${{ inputs.upload_sarif }}
      results-file-name: osv-scanner-pr-results-${{ github.workflow }}-${{ github.job }}.sarif

  trivy_source:
    name: "Trivy Source (fs: vuln+secret)"
    if: ${{ inputs.enable_trivy_source }}
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
      actions: read
      security-events: write
    env:
      SARIF_FILE: trivy-source-results-${{ github.workflow }}-${{ github.job }}.sarif
      SARIF_CATEGORY: vuln-source
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Trivy source scan (SARIF)
        continue-on-error: ${{ !inputs.fail_on_vuln }}
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8 # 0.33.1
        with:
          scan-type: fs   # Filesystem scan mode
          scan-ref: ${{ inputs.path }}
          scanners: ${{ inputs.enable_secret_scan && 'vuln,secret' || 'vuln' }}
          skip-dirs: ${{ inputs.skip_dirs }}
          format: sarif
          output: ${{ env.SARIF_FILE }}
          vuln-type: 'os,library'
          severity: ${{ inputs.trivy_severity }}
          ignore-unfixed: ${{ inputs.ignore_unfixed }}
          exit-code: '1'

      - name: Upload source scan results
        if: ${{ !cancelled() && inputs.upload_sarif }}
        uses: github/codeql-action/upload-sarif@5d4e8d1aca955e8d8589aabd499c5cae939e33c7 # v4.31.9
        with:
          sarif_file: ${{ env.SARIF_FILE }}
          category: ${{ env.SARIF_CATEGORY }}

  trivy_image:
    name: Trivy Image
    needs: validate_inputs
    if: ${{ inputs.enable_trivy_image }}
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      actions: read
      security-events: write
      packages: read
    env:
      SARIF_FILE: trivy-image-results-${{ github.workflow }}-${{ github.job }}.sarif
      SARIF_CATEGORY: vuln-image
    steps:
      - name: Trivy image scan (SARIF)
        continue-on-error: ${{ !inputs.fail_on_vuln }}
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8 # 0.33.1
        with:
          image-ref: ${{ inputs.image_ref }}
          format: sarif
          output: ${{ env.SARIF_FILE }}
          vuln-type: 'os,library'
          severity: ${{ inputs.trivy_severity }}
          ignore-unfixed: ${{ inputs.ignore_unfixed }}
          exit-code: '1'

      - name: Upload image scan results
        if: ${{ !cancelled() && inputs.upload_sarif }}
        uses: github/codeql-action/upload-sarif@5d4e8d1aca955e8d8589aabd499c5cae939e33c7 # v4.31.9
        with:
          sarif_file: ${{ env.SARIF_FILE }}
          category: ${{ env.SARIF_CATEGORY }}
