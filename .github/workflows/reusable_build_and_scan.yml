name: Reusable Build and Scan

on:
  workflow_call:
    inputs:
      component_name:
        description: 'Component name (e.g., compass, beacon-distro)'
        required: true
        type: string
      containerfile_path:
        description: 'Containerfile path relative to repo root'
        required: true
        type: string
      context_path:
        description: 'Build context path'
        required: true
        type: string
      image_name:
        description: 'Full image name (e.g., ghcr.io/org/image)'
        required: true
        type: string
      trivy_severity:
        description: 'Vulnerability scan severities (comma-separated)'
        required: false
        type: string
        default: 'HIGH,CRITICAL'
      ignore_unfixed:
        description: 'Ignore unfixed vulnerabilities'
        required: false
        type: boolean
        default: true
      scan_secret_severity:
        description: 'Secret scan severities (comma-separated)'
        required: false
        type: string
        default: 'HIGH,CRITICAL,MEDIUM'

concurrency:
  group: ${{ github.workflow }}-${{ inputs.image_name }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  scan:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    permissions:
      contents: read
      packages: none
      id-token: none
      security-events: write
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Container metadata (scan)
        id: meta
        uses: docker/metadata-action@c299e40c65443455700f0fdfc63efafe5b349051 # v5.10.0
        with:
          images: ${{ inputs.image_name }}
          tags: |
            type=ref,event=branch,suffix=-{{sha}}
            type=sha,format=long,prefix=sha-
          labels: |
            org.opencontainers.image.title=${{ inputs.component_name }}
            org.opencontainers.image.description=ComplyBeacon ${{ inputs.component_name }} service
            org.opencontainers.image.vendor=ComplyTime

      - name: Set up QEMU
        uses: docker/setup-qemu-action@c7c53464625b32c7a7e944ae62b3e17d2b600130 # v3.7.0

      - name: Set up Container Buildx
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # v3.11.1

      - name: Build (single-arch, local load)
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
        with:
          context: ${{ inputs.context_path }}
          file: ${{ inputs.containerfile_path }}
          load: true
          push: false
          platforms: linux/amd64
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=${{ inputs.component_name }}
          cache-to: type=gha,mode=max,scope=${{ inputs.component_name }}
          sbom: false
          provenance: false

      - name: Scan image for secrets
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8 # 0.33.1
        with:
          image-ref: ${{ inputs.image_name }}:sha-${{ github.sha }}
          exit-code: 1
          scanners: secret
          severity: ${{ inputs.scan_secret_severity }}
          format: table

      - name: Scan image for vulnerabilities (SARIF)
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8 # 0.33.1
        with:
          image-ref: ${{ inputs.image_name }}:sha-${{ github.sha }}
          format: sarif
          output: trivy-results.sarif
          vuln-type: 'os,library'
          severity: ${{ inputs.trivy_severity }}
          ignore-unfixed: ${{ inputs.ignore_unfixed }}

      - name: Upload vulnerability scan results
        uses: github/codeql-action/upload-sarif@cf1bb45a277cb3c205638b2cd5c984db1c46a412 # v4.31.7
        with:
          sarif_file: trivy-results.sarif
          category: ${{ inputs.component_name }}-vulnerabilities


