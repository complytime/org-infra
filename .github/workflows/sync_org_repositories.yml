---
name: Sync Organization Repositories

#on:
  # Run on push to main branch when relevant files change
  #push:
  #  branches:
  #    - main
  #  paths:
  #    - '.github/ISSUE_TEMPLATE/**'
  #    - '.github/workflows/**'
  #    - '.github/dependabot.yml'
  #    - '.github/pull_request_template.md'
  #    - 'scripts/sync-org-repositories.py'
  #    - '.golangci.yml'
  #    - '.mega-linter.yml'
  #    - '.yamllint.yml'
  #    - 'commitlint.config.js'
  #    - 'ruff.toml'
  #    - 'sync-config.yml'

  # Run on schedule (weekly on Monday at 00:00 UTC)
  # schedule:
  #   - cron: '0 0 * * 1'

# Only allow manual trigger during testing phase. Above lines will be uncommented when testing is complete.
on:
  workflow_dispatch:
    inputs:
      repos:
        description: 'Specific repositories to sync (space-separated, leave empty for all)'
        required: false
        type: string
      dry_run:
        description: 'Dry run mode (no changes will be made)'
        required: false
        type: boolean
        default: false

# Minimal permissions for workflow
# The GitHub App token will have its own permissions
permissions:
  contents: read

jobs:
  sync-repositories:
    name: Sync Repositories via Fork
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
      - name: Checkout org-infra Repository
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1
        with:
          fetch-depth: 1

      - name: Generate GitHub App Token
        id: generate-token
        uses: actions/create-github-app-token@67018539274d69449ef7c02e8e71183d1719ab42 # v2.1.4
        with:
          app-id: ${{ secrets.SYNC_APP_ID }}
          private-key: ${{ secrets.SYNC_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}

      - name: Set up Python
        uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c # v6.0.0
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Configure Git
        run: |
          git config --global user.name "complytime-repo-sync[bot]"
          git config --global user.email "complytime-repo-sync[bot]@users.noreply.github.com"

      - name: Run Sync Script (scheduled or push)
        if: github.event_name != 'workflow_dispatch'
        env:
          GITHUB_TOKEN: ${{ steps.generate-token.outputs.token }}
        run: |
          python scripts/sync-org-repositories.py \
            --org ${{ github.repository_owner }} \
            --config sync-config.yml

      - name: Run sync script (manual - all repos)
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.repos == ''
        env:
          GITHUB_TOKEN: ${{ steps.generate-token.outputs.token }}
        run: |
          python scripts/sync-org-repositories.py \
            --org ${{ github.repository_owner }} \
            --config sync-config.yml \
            ${{ github.event.inputs.dry_run == 'true' && '--dry-run' || '' }}

      - name: Run sync script (manual - specific repos)
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.repos != ''
        env:
          GITHUB_TOKEN: ${{ steps.generate-token.outputs.token }}
        run: |
          python scripts/sync-org-repositories.py \
            --org ${{ github.repository_owner }} \
            --config sync-config.yml \
            --repos ${{ github.event.inputs.repos }} \
            ${{ github.event.inputs.dry_run == 'true' && '--dry-run' || '' }}

      - name: Summary
        if: always()
        run: |
          {
            echo "## Sync Organization Repositories Complete"
            echo "- **Organization:** ${{ github.repository_owner }}"
            echo "- **Trigger:** ${{ github.event_name }}"

            if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
              echo "- **Dry Run:** ${{ github.event.inputs.dry_run }}"
              if [ -n "${{ github.event.inputs.repos }}" ]; then
                echo "- **Repositories:** ${{ github.event.inputs.repos }}"
              else
                echo "- **Repositories:** All (from peribolos.yml)"
              fi
            else
              echo "- **Repositories:** All (from peribolos.yml)"
            fi
            echo ""
            echo "### Workflow Details"
            echo "- Uses fork-based workflow (no write access required to target repos)"
            echo "- PRs created from GitHub App forks to upstream repositories"
          } >> "$GITHUB_STEP_SUMMARY"
