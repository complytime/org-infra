# Reusable workflow for building and publishing container images with security best practices
# This workflow implements a 4-stage secure build pipeline:
# 1. Local build + 2. Secret & vulnerability scanning + 3. Push (Buildx emits SBOM & provenance) + 4. Signing & verification
# SBOMs are standardized on SPDX for broad tooling support, Cosign verification (`--type spdx`), and GHCR interoperability.
# Note: Repository secret scanning and containerfile linting are handled by reusable_ci.yml (MegaLinter)

name: Reusable Build and Publish Image

on:
  workflow_call:
    inputs:
      allowed_identity_regex:
        description: 'Regex for Cosign certificate identity (optional, defaults to org-level)'
        required: false
        type: string
      component_name:
        description: 'Component name (e.g., compass, beacon-distro)'
        required: true
        type: string
      containerfile_path:
        description: 'Containerfile path relative to repo root (e.g., compass/images/Containerfile.compass)'
        required: true
        type: string
      context_path:
        description: 'Build context path (e.g., ./compass)'
        required: true
        type: string
      force_rebuild:
        description: 'Force rebuild without cache'
        required: false
        type: boolean
        default: false
      platforms:
        description: 'Comma-separated target platforms (passed to push stage)'
        required: false
        type: string
        default: 'linux/amd64,linux/arm64'
      image_name:
        description: 'Full image name (e.g., ghcr.io/complytime/complybeacon-compass)'
        required: true
        type: string
      registry_username:
        description: 'Username for registry login when using a custom token (defaults to github.actor)'
        required: false
        type: string
    secrets:
      registry_token:
        description: 'Optional registry token for docker/login-action. If not provided, falls back to GITHUB_TOKEN.'
        required: false
 

permissions: 
    contents: none
    security-events: none
    id-token: none
    packages: none

concurrency:
  group: ${{ github.workflow }}-${{ inputs.image_name }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build_and_scan:
    permissions:
      contents: read
      security-events: write
    uses: ./.github/workflows/reusable_build_and_scan.yml
    with:
      component_name: ${{ inputs.component_name }}
      containerfile_path: ${{ inputs.containerfile_path }}
      context_path: ${{ inputs.context_path }}
      image_name: ${{ inputs.image_name }}

  push:
    if: ${{ github.ref_protected }}
    needs: build_and_scan
    permissions:
      contents: read
      packages: write
    uses: ./.github/workflows/reusable_push.yml
    with:
      component_name: ${{ inputs.component_name }}
      containerfile_path: ${{ inputs.containerfile_path }}
      context_path: ${{ inputs.context_path }}
      image_name: ${{ inputs.image_name }}
      force_rebuild: ${{ inputs.force_rebuild }}
      platforms: ${{ inputs.platforms }}
      registry_username: ${{ inputs.registry_username }}
    secrets:
      registry_token: ${{ secrets.registry_token }}

  sign_and_verify:
    if: ${{ github.ref_protected }}
    needs: push
    permissions:
      packages: write
      id-token: write
    uses: ./.github/workflows/reusable_sign_and_verify.yml
    with:
      image_name: ${{ inputs.image_name }}
      digest: ${{ needs.push.outputs.digest }}
      allowed_identity_regex: ${{ inputs.allowed_identity_regex }}