# Reusable Publish Image Workflow
# ================================
# Orchestrates a 3-stage secure container build pipeline:
#   1. Push   - Build multi-arch image with SBOM & SLSA provenance (via Buildx)
#   2. Scan   - Vulnerability scan the pushed image (Trivy)
#   3. Sign   - Keyless signing & verification (Cosign + Sigstore)

name: Reusable Publish Image

on:
  workflow_call:
    inputs:
      allowed_identity_regex:
        description: 'Regex for Cosign certificate identity (optional, defaults to org-level)'
        required: false
        type: string
      component_name:
        description: 'Component name (e.g., compass, beacon-distro)'
        required: true
        type: string
      containerfile_path:
        description: 'Containerfile path relative to repo root (e.g., compass/images/Containerfile.compass)'
        required: true
        type: string
      context_path:
        description: 'Build context path (e.g., ./compass)'
        required: true
        type: string
      force_rebuild:
        description: 'Force rebuild without cache'
        required: false
        type: boolean
        default: false
      platforms:
        description: 'Comma-separated target platforms (passed to push stage)'
        required: false
        type: string
        default: 'linux/amd64,linux/arm64'
      image_name:
        description: 'Image name without registry (e.g., org/image-name)'
        required: true
        type: string
      image_description:
        description: 'Image description for OCI label (defaults to component_name)'
        required: false
        type: string
      image_vendor:
        description: 'Vendor name for OCI label'
        required: false
        type: string
      registries:
        description: 'Comma-separated list of registries to push to (e.g., ghcr.io,quay.io)'
        required: false
        type: string
        default: 'ghcr.io'
      registry_username:
        description: 'Username for GHCR login (defaults to github.actor)'
        required: false
        type: string
    secrets:
      registry_token:
        description: 'Optional GHCR token. If not provided, falls back to GITHUB_TOKEN.'
        required: false
      quay_username:
        description: 'Quay.io username/robot for login (only needed if pushing to quay.io)'
        required: false
      quay_password:
        description: 'Quay.io password/token for login (only needed if pushing to quay.io)'
        required: false

# Workflow-level permissions: deny all by default
permissions:
  contents: none
  security-events: none
  id-token: none
  packages: none

concurrency:
  group: reusable-publish-image-${{ inputs.image_name }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  push:
    if: ${{ github.ref_protected }}
    permissions:
      contents: read    # Checkout repository
      packages: write   # Push to GHCR
      actions: read     # Access GHA cache (Buildx layer caching)
    uses: ./.github/workflows/reusable_push.yml
    with:
      component_name: ${{ inputs.component_name }}
      containerfile_path: ${{ inputs.containerfile_path }}
      context_path: ${{ inputs.context_path }}
      image_name: ${{ inputs.image_name }}
      image_description: ${{ inputs.image_description }}
      image_vendor: ${{ inputs.image_vendor }}
      registries: ${{ inputs.registries }}
      force_rebuild: ${{ inputs.force_rebuild }}
      platforms: ${{ inputs.platforms }}
      registry_username: ${{ inputs.registry_username }}
    secrets:
      registry_token: ${{ secrets.registry_token }}
      quay_username: ${{ secrets.quay_username }}
      quay_password: ${{ secrets.quay_password }}

  scan_pushed_image:
    if: ${{ github.ref_protected }}
    needs: push 
    permissions:
      contents: read        
      actions: read         
      security-events: write  
    uses: ./.github/workflows/reusable_vuln_scan.yml
    with:
      enable_osv: false   
      enable_trivy_image: true
      image_ref: ${{ needs.push.outputs.primary_image }}:sha-${{ github.sha }}

  sign_and_verify:
    if: ${{ github.ref_protected }}
    needs: [push, scan_pushed_image]  
    permissions:
      packages: write   
      id-token: write   
    uses: ./.github/workflows/reusable_sign_and_verify.yml
    with:
      image_name: ${{ needs.push.outputs.full_image_names }}
      digest: ${{ needs.push.outputs.digest }}
      allowed_identity_regex: ${{ inputs.allowed_identity_regex }}
      registry_username: ${{ inputs.registry_username }}
    secrets:
      registry_token: ${{ secrets.registry_token }}
      quay_username: ${{ secrets.quay_username }}
      quay_password: ${{ secrets.quay_password }}
